var textSt = `Welcome, dear traveler.
Find a comfortable position, and let your body grow heavy and soft.
Close your eyes, if you haven't already, and allow your breathing to slow...
to deepen...
in, and out.
Tonight, we are going to a quiet place
A gentle place.
We are going to a small, hidden lake.
In the vast, sleeping heart of Canada.
The air here is cool and clean
It carries the serene scent of pine needles and damp earth.
It is the hour after sunset.
You are standing at the edge of the water
On a smooth, flat granite rock, worn soft by centuries of ice and rain.
The rock still holds the faint, soothing warmth of the day's sun
A gentle heat that seeps up through the soles of your feet, relaxing you...
grounding you.
Before you, the lake is perfectly still.
It is not black, but a deep, velvety indigo
A mirror for the first shy stars that are beginning to prick the dome of the sky.
On the far shore, a forest of pine and spruce stands as a dark, protective silhouette
A soft, fuzzy line against the fading light.
There is no wind.
Not a single branch trembles.
Everything is at peace.
Listen...
The only sound is a gentle, rhythmic lapping...the water...
kissing the shore...over...and over...
a slow, liquid heartbeat. shhhhh...
It is a sound older than time, a lullaby for the land.
With every soft shhhhh, feel a little more of the day's tension...
its worries...
its thoughts...
Feel it drift away from you, dissolving into the tranquil dusk.
You sit down on the warm rock, feeling its solid, unmoving strength.
Above you, the sky deepens from soft blue to a profound, velvety violet.
More stars appear now, slowly, calmly.
As if they are opening their sleepy eyes one by one.
There is no moon tonight
The stars have the stage all to themselves
Their light pure and clear and gentle on your face.
You notice a loon, far out on the water.
It is a dark, solitary shape, floating in a pool of starlight.
It lets out a single, soft call
A long, mournful, yet deeply peaceful note that echoes across the lake and fades slowly
Slowly into the silence.
It is not a sound of alarm, but a sound of contentment.
A goodnight call to the forest.
All is well.
Breathe in...
the cool, pine-scented air.
Breathe out...
any lingering restlessness.
Feel the immense quiet of this Canadian wilderness wrap around you like a soft, heavy blanket.
It is a quiet so deep you can feel it, a presence that holds you safely.
The vastness of this land, from the Rocky Mountains far to the west to the endless boreal forests that stretch to the Arctic, is all sleeping.
And you are here, in its very center, safe and still.
Look at the reflection of the stars in the black water.
It is impossible to tell where the sky ends and the lake begins.
You are floating between two heavens, cradled in the calm.
Your eyelids are growing heavy, mirroring the slow, slow closing of the flowers on the shore.
The water's whisper is growing softer...shhhhh...
The rock beneath you is so warm, so comfortable.
The stars above are so gentle, their light a soft, silvery balm.
The loon is silent now, asleep on the water.
The forest is a dark, slumbering giant.
You are part of this peace.
You are part of this quiet night.
Let the stillness outside become the stillness within.
The lake holds the stars...
the forest holds the silence...
and this moment holds you. Shhhhh...
All is well. Shhhhh...
It is time to rest now.
Sleep.

<muoborder>

Bienvenido, querido viajero.
Encuentra una posición cómoda, y deja que tu cuerpo se vuelva pesado y suave.
Cierra los ojos, si no lo has hecho ya, y permite que tu respiración se ralentice...
que se profundice...
inhala, y exhala.
Esta noche, vamos a un lugar tranquilo
Un lugar gentil.
Vamos a un pequeño lago escondido.
En el vasto corazón dormido de Canadá.
El aire aquí es fresco y limpio
Lleva el sereno aroma de agujas de pino y tierra húmeda.
Es la hora después del atardecer.
Estás de pie al borde del agua
Sobre una roca de granito lisa y plana, suavizada por siglos de hielo y lluvia.
La roca aún conserva el tenue y reconfortante calor del sol del día
Un calor suave que se filtra hacia arriba a través de las plantas de tus pies, relajándote...
anclándote.
Ante ti, el lago está perfectamente quieto.
No es negro, sino un índigo profundo y aterciopelado
Un espejo para las primeras estrellas tímidas que comienzan a puntear la cúpula del cielo.
En la orilla lejana, un bosque de pinos y abetos se erige como una silueta oscura y protectora
Una línea suave y difusa contra la luz que se desvanece.
No hay viento.
Ni una sola rama tiembla.
Todo está en paz.
Escucha...
El único sonido es un suave y rítmico chapoteo... el agua...
besando la orilla... una... y otra vez...
un lento latido líquido. shhhhh...
Es un sonido más antiguo que el tiempo, una nana para la tierra.
Con cada suave shhhhh, siente cómo un poco más de la tensión del día...
sus preocupaciones...
sus pensamientos...
Siente cómo se aleja de ti, disolviéndose en el crepúsculo tranquilo.
Te sientas en la roca cálida, sintiendo su sólida e inamovible fuerza.
Sobre ti, el cielo se profundiza de un azul suave a un violeta profundo y aterciopelado.
Aparecen más estrellas ahora, lentamente, con calma.
Como si estuvieran abriendo sus ojos somnolientos una por una.
No hay luna esta noche
Las estrellas tienen el escenario para ellas solas
Su luz pura, clara y suave sobre tu rostro.
Notas un colimbo, lejos en el agua.
Es una forma oscura y solitaria, flotando en un charco de luz estelar.
Emite un solo y suave llamado
Una nota larga, melancólica, pero profundamente pacífica que resuena a través del lago y se desvanece lentamente
Lentamente en el silencio.
No es un sonido de alarma, sino un sonido de contentamiento.
Un llamado de buenas noches al bosque.
Todo está bien.
Inhala...
el aire fresco con aroma a pino.
Exhala...
cualquier inquietud persistente.
Siente cómo la inmensa quietud de esta naturaleza salvaje canadiense te envuelve como una manta suave y pesada.
Es una quietud tan profunda que puedes sentirla, una presencia que te sostiene con seguridad.
La vastedad de esta tierra, desde las Montañas Rocosas lejos al oeste hasta los interminables bosques boreales que se extienden hasta el Ártico, todo está dormido.
Y tú estás aquí, en su mismo centro, seguro y quieto.
Mira el reflejo de las estrellas en el agua negra.
Es imposible distinguir dónde termina el cielo y comienza el lago.
Estás flotando entre dos cielos, acunado en la calma.
Tus párpados se vuelven pesados, imitando el lento, lento cierre de las flores en la orilla.
El susurro del agua se hace más suave... shhhhh...
La roca debajo de ti es tan cálida, tan cómoda.
Las estrellas arriba son tan gentiles, su luz un bálsamo plateado y suave.
El colimbo está en silencio ahora, dormido en el agua.
El bosque es un gigante oscuro y dormido.
Tú eres parte de esta paz.
Tú eres parte de esta noche tranquila.
Deja que la quietud exterior se convierta en la quietud interior.
El lago sostiene las estrellas...
el bosque sostiene el silencio...
y este momento te sostiene a ti. Shhhhh...
Todo está bien. Shhhhh...
Es hora de descansar ahora.
Duerme.`;


var spanishDictionary =`["abetos - firs","abriendo - opening","acunado - cradled","agua - water","agujas - needles","ahora - now","aire - air","al - to the (a + el)","alarma - alarm","aleja - moves away","anclándote - grounding","ante - before / in the presence of","antiguo - ancient","aparecen - appear","aquí - here","aroma - scent","arriba - above","ártico - Arctic","atardecer - sunset","aterciopelado - velvety","aún - still, yet","azul - blue","bálsamo - balm","besando - kissing","bien - well, good","bienvenido - welcome","borde - edge","boreales - boreal","bosque - forest, woods","bosques - forests","buenas - good (feminine plural)","cada - each, every","cálida - warm","calma - serenity","calor - warmth","canadá - Canada","canadiense - Canadian","centro - center","chapoteo - splashing","charco - puddle","cielo - sky, heaven","cielos - skies","cierra - close","cierre - close","clara - clear","colimbo - loon","comienza - begins","comienzan - begin","como - as, like, how","cómo - how","cómoda - comfortable","con - with","conserva - preserves","contentamiento - contentment","contra - against","convierta - convert","corazón - heart","crepúsculo - twilight","cualquier - any","cuerpo - Body","cúpula - dome","de - of, from","debajo - beneath","deja - let","del - of the (de + el)","descansar - rest","desde - from, since","después - after, afterwards","desvanece - fades","día - day","difusa - diffuse","disolviéndose - dissolving","distinguir - distinguish","dónde - where","dormido - sleeping","dos - two","duerme - sleeps","e - and (used instead of y before words starting with i or hi)","el - the","ellas - they","emite - emits","en - in, on","encuentra - finds","entre - between / among","envuelve - envelops","eres - you are","erige - erects","es - is (from ser)","escenario - scene","escondido - hidden","escucha - listens","espejo - mirror","está - is (from estar)","esta - this (feminine singular)","estás - Are you?","este - this (masculine singular)","estelar - stellar","estrellas - stars","estuvieran - were","exhala - exhale","exterior - outside","extienden - extend","filtra - filters","flores - flowers","flotando - floating","forma - way, form","fresco - fresh","fuerza - strength / force","gentil - gentle","gentiles - gentle","gigante - giant","granito - granite","hace - makes / does / ago","hacia - towards","hasta - until, up to, even","hay - there is, there are (from haber)","hecho - fact, deed, or done/made (past participle of hacer)","hielo - ice","hora - time","húmeda - damp","imitando - imitating","imposible - impossible","inamovible - immovable","índigo - indigo","inhala - inhale","inmensa - immense","inquietud - restlessness","interior - inside","interminables - endless","la - the (feminine singular)","lago - lake","larga - long (feminine)","las - the (feminine plural)","latido - heartbeat","lejana - distant","lejos - far / far away","lentamente - slowly","lento - slow","limpio - clean","línea - line","líquido - liquid","lisa - smooth","llamado - called (past participle of llamar), call","lleva - carries","lluvia - rain","lo - It / Him!","los - the (masculine plural)","lugar - place","luna - moon","luz - light","manta - blanket","más - more","melancólica - melancholic","mira - look","mismo - same, himself/herself/itself (after a pronoun)","momento - moment","montañas - mountains","nana - lullaby","naturaleza - nature","negra - black","negro - black","ni - nor, neither, not even","noche - night","noches - nights","nota - note","notas - notes","oeste - west","ojos - eyes","orilla - shore","oscura - dark","oscuro - dark","otra - other / another (feminine)","pacífica - peaceful","para - for, in order to","párpados - eyelids","parte - part","paz - peace","pensamientos - thoughts","pequeño - small","perfectamente - perfectly","permite - allows","pero - but","persistente - persistent","pesada - heavy","pesado - heavy","pesados - heavy","pie - foot","pies - feet","pino - pine","pinos - pines","plana - flat","plantas - plants","plateado - silver","poco - little / few / bit","por - by, for, through","posición - position","preocupaciones - worries","presencia - presence","primeras - first","profunda - deep","profundamente - deeply","profundice - deepen","profundiza - deepens","profundo - deep","protectora - protective","puedes - you can (from poder)","puntear - to dot","pura - pure","que - that, what","querido - Dear / Beloved","quieto - still","quietud - stillness","ralentice - slow down","rama - branch","reconfortante - soothing","reflejo - reflection","relajándote - relaxing","respiración - breath","resuena - resonates","rítmico - rhythmic","roca - rock","rocosas - rocky","rostro - face","salvaje - wild","se - oneself, himself, herself, itself, themselves (reflexive pronoun), or used in impersonal constructions","seguridad - security / safety","seguro - safe / sure / insurance","sentirla - feel it","sereno - serene","shhhhh - shh","si - if","sientas - feel","siente - feels","siglos - centuries","silencio - silence","silueta - silhouette","sino - but, but rather (used after a negative clause)","sintiendo - feeling","sobre - on / over / about","sol - sun / alone","sola - alone","solas - alone","sólida - solid","solitaria - solitary","solo - only, alone","somnolientos - drowsy","son - are","sonido - sound","sostiene - holds","su - his, her, its, their, your (formal)","suave - soft","suavizada - softened","sus - his, her, its, their, your (formal) (plural)","susurro - whisper","tan - so / such / as","te - you (informal singular) (direct or indirect object pronoun)","tensión - tension","tenue - faint","termina - ends","ti - you (after a preposition)","tiembla - trembles","tiempo - time, weather","tienen - have","tierra - earth","tímidas - timid","todo - all, whole, everything","tranquila - calm","tranquilo - calm","través - through","tú - you (informal subject pronoun)","tu - your (informal singular)","tus - your (informal plural)","un - a, an (masculine)","una - a, an (feminine)","único - unique, only","vamos - let's go","vastedad - vastness","vasto - vast","vez - time / occasion","viajero - traveler","viento - wind","violeta - violet","vuelva - return","vuelven - return","y - and","ya - already, now"]`;
var slm =`{"a":{"start":0,"end":21},"á":{"start":17,"end":17},"b":{"start":22,"end":30},"c":{"start":31,"end":60},"d":{"start":61,"end":76},"e":{"start":77,"end":101},"f":{"start":102,"end":107},"g":{"start":108,"end":111},"h":{"start":112,"end":119},"i":{"start":120,"end":128},"í":{"start":123,"end":123},"l":{"start":129,"end":149},"m":{"start":150,"end":156},"n":{"start":157,"end":165},"o":{"start":166,"end":171},"p":{"start":172,"end":207},"q":{"start":208,"end":211},"r":{"start":212,"end":222},"s":{"start":223,"end":253},"t":{"start":254,"end":271},"u":{"start":272,"end":273},"ú":{"start":274,"end":274},"v":{"start":275,"end":283},"y":{"start":284,"end":285}}`;

//var EHIMGURL = './jiveRPG/canada/';
var EHIMGURL = 'https://ik.imagekit.io/pnscgil5d/';
var reperc = {
    starter:false,
    storylines:[],
    starterParagraph:false,
    bmidx:false,
    storyvis:['ca_z.jpg','ca_y.jpg','ca_xy.jpg','ca_xx.jpg','ca_x.jpg','ca_w.jpg','ca_v.jpg','ca_u.jpg','ca_t.jpg','ca_s.jpg','ca_r.jpg','ca_q.jpg','ca_p.jpg','ca_o.jpg','ca_n.jpg','ca_m.jpg','ca_l.jpg','ca_k.jpg','ca_j.jpg','ca_i.jpg','ca_h.jpg','ca_g.jpg','ca_f.jpg','ca_e.jpg','ca_d.jpg','ca_c.jpg','ca_b.jpg','ca_a.jpg','ca_9.jpg','ca_8.jpg','ca_7.jpg','ca_5.jpg','ca_4.jpg','ca_3.jpg','ca_2.jpg','ca_1o.jpg','ca_1n.jpg','ca_1m.jpg','ca_1l.jpg','ca_1k.jpg','ca_1j.jpg','ca_1i.jpg','ca_1h.jpg','ca_1g.jpg','ca_1f.jpg','ca_1e.jpg','ca_1d.jpg','ca_1c.jpg','ca_1b.jpg','ca_1a.jpg','ca_1.jpg'],
    setBookmark:function(x){
        if(reperc.localstorage == false){return;}
        console.log('currentPar:'+x);
        reperc.bookmark[reperc.bmidx].cpar = x;
        reperc.localstorage.setItem('easternHeadBM',JSON.stringify(reperc.bookmark));
    },
    initBookmark:function(){
        const ehbmtitle = 'NDss1';
        
        if (typeof localStorage == "object"){
            reperc.localstorage =  localStorage;
        } else if (typeof globalStorage == "object"){
            reperc.localstorage = globalStorage[location.host];
        } else {
            reperc.localstorage = false;
        }
        if(reperc.localstorage !== false){
            reperc.bookmark = reperc.localstorage.getItem('easternHeadBM');
            if(reperc.bookmark == null){
                reperc.bookmark = [];
                reperc.bmidx = 0;
                reperc.bookmark[0] = {title:ehbmtitle,cpar:0};
            }
            else{
                reperc.bookmark = JSON.parse(reperc.bookmark);
                for(var i=0;i<reperc.bookmark.length;i++){
                    if(reperc.bookmark[i].title == ehbmtitle){
                        reperc.starterParagraph = reperc.bookmark[i].cpar;
                        reperc.bmidx = i;
                        break;
                    }
                }
                if(reperc.bmidx === false){
                    reperc.bmidx = reperc.bookmark.length;
                    reperc.bookmark[reperc.bmidx] = {title:ehbmtitle,cpar:0};
                }
            }
        }
    },
    initDictionary:function(){
        spanishDictionary = JSON.parse(spanishDictionary);
        reperc.letterMap = JSON.parse(slm);
    },
    initStory:function(){
        reperc.initBookmark();
        reperc.initDictionary();
        reperc.storyvidx = [];
        for(var i=0;i<reperc.storyvis.length;i++){
            reperc.storyvidx[reperc.storyvidx.length] = i;
        }
        textSt = textSt.split('<muoborder>');
        for(var i=0;i<textSt.length;i++){
            textSt[i] = textSt[i].trim();
            if(textSt[i] == '') continue;
            reperc.storylines[i] = [];
            textSt[i] = textSt[i].split('\n');
            for(var ix=0;ix<textSt[i].length;ix++){
                textSt[i][ix] = textSt[i][ix].trim();
                if(textSt[i][ix] == '') continue;
                reperc.storylines[i][reperc.storylines[i].length] = textSt[i][ix];
            }
        }
	},
    nextHdlr:function(x){
        var stvidx = jovuniverse.getrand(0,reperc.storyvidx.length);
        var stvi = reperc.storyvidx[stvidx];
        storyline.chapters[storyline.current_chap].elements.narration.illustration = EHIMGURL+reperc.storyvis[stvi];
        reperc.storyvidx.splice(stvidx,1);
        if(!reperc.storyvidx.length){
            for(var i=0;i<reperc.storyvis.length;i++){
                reperc.storyvidx[reperc.storyvidx.length] = i;
            }
        }
        reperc.setBookmark(x);
    },
    rp:function(){
        storyline.current_chap = reperc.starter;
        if(reperc.starterParagraph !== false){
          storyline.unfold_ = true;
          console.log('startingPar:'+reperc.starterParagraph);
          storyline.chapters[storyline.current_chap].unfoldx(reperc.starterParagraph);
        }
        else {
          storyline.chapters[storyline.current_chap].unfold();
        }
        var stvidx = jovuniverse.getrand(0,reperc.storyvidx.length);
        var stvi = reperc.storyvidx[stvidx];
        storyline.chapters[storyline.current_chap].elements.narration.illustration = EHIMGURL+reperc.storyvis[stvi];
        reperc.storyvidx.splice(stvidx,1);

        document.addEventListener('unfoldx', e => {
            reperc.nextHdlr(e.detail);          
        });
        
  }
};

storyline.intro = `<p>One of a series of stories of the sleep-story genre in EasternHead's free Library designed to help you sleep, but also learn new words in foreign languages</p>
<div style="font-size:smaller;">
<p>Credits:</p>
<p>Stories:<br> AIs</p>
<p>Translation:<br> AIs</p>
<p>Images:<br><ul><li><a href="https://www.rawpixel.com" target="_blank">rawpixel.com</a></li><li><a href="https://www.pixabay.com" target="_blank">pixabay.com</a></li></ul></p></div>`;

storyline.lang = ['EN','ES'];
storyline.clang = storyline.deflang = 'es';
var chidx;
var n;

reperc.starter = 1;
config = {type:'repercussion',effect:new repercussion(reperc.rp),prerequisite:false};
chidx = storyline.addChapter(config);

reperc.initStory();
config = {type:'narration',narration:false};
n = new narration();
for(var i=0;i<reperc.storylines[1].length;i++){
    //es,en,fr,de,it,ru,ja,ko
	n.addNarration(reperc.storylines[1][i],reperc.storylines[0][i],null,null,null,null,null,null);
}
config.narration = n;
chidx = storyline.addChapter(config);

storyline.dictionfn = function(t,l){
    $('#dictionary').remove();
    $('.txtfrg.inq').removeClass('inq');
    const pos = $(l).offset();
    $(l).addClass('inq');
    t = t.toLowerCase().replace(/^[\p{P}\p{S}\s]+|[\p{P}\p{S}\s]+$/gu, '');
    t = t +' - ';
    let xx = t[0].toLowerCase();

    if(storyline.clang == 'es'){
        if (!reperc.letterMap[xx]){
            window.open('https://translate.google.com/?sl='+storyline.clang+'&tl=en&text='+t+'&op=translate');
            return;
        }
        for(var i=reperc.letterMap[xx].start;i<=reperc.letterMap[xx].end;i++){
            if(spanishDictionary[i].indexOf(t) === 0){
                $('body').append('<div id="dictionary" style="top:'+(pos.top-40)+'px;left:'+pos.left+'px;">'+spanishDictionary[i].split(' - ')[1]+'</div>').addClass('dictionInq');
                return;
            }
        }
        window.open('https://translate.google.com/?sl='+storyline.clang+'&tl=en&text='+t+'&op=translate');
    }
};
$('#text5').prop('src',EHIMGURL+'ca_6.jpg');

var textSt = `
Canadian Rockies
It's a cool, crisp evening in the Canadian Rockies.
The sun has just dipped below the horizon, casting a warm, golden glow over the towering, snow-capped peaks that surround you.
You're nestled in a cozy cabin, the crackling of the fireplace the only sound that breaks the peaceful silence.
Outside, the trees sway gently in the cool mountain breeze,
their leaves rustling like a soft, soothing lullaby.
As you sink deeper into the plush armchair, a mug of hot herbal tea warms your hands.
The aromatic steam rises, filling the air with the calming scents of chamomile and lavender.
With each slow, deep breath, you feel your muscles relax and your mind begin to drift.
The flickering firelight casts dancing shadows across the wooden walls, creating a mesmerizing, hypnotic display.
Your eyelids grow heavy,
your thoughts slowing to a crawl as you become enveloped in the tranquility of this mountain sanctuary.
The soft patter of rain begins to fall outside,
the gentle pitter-patter creating a natural, rhythmic soundtrack to lull you into a deep, restful sleep.
You sink deeper into the chair, your body growing heavier and your breathing becoming slow and steady.
The worries of the day fade away,
replaced by a profound sense of calm and serenity.
You are safe
you are at peace
you are home
As you drift off to sleep, a small smile crosses your lips.
knowing that you are exactly where you need to be.

<muoborder>

Rocosas Canadienses
Es una tarde fresca y crujiente en las Rocosas Canadienses.
El sol acaba de hundirse bajo el horizonte, proyectando un cálido resplandor dorado sobre las imponentes cumbres nevadas que te rodean.
Estás acurrucado en una acogedora cabaña, el crepitar de la chimenea es el único sonido que rompe el silencio pacífico.
Afuera, los árboles se mecen suavemente con la fresca brisa de la montaña,
sus hojas susurrando como una suave y calmante nana.
Mientras te hundes más en el mullido sillón, una taza de té herbal caliente calienta tus manos.
El vapor aromático asciende, llenando el aire con los tranquilizadores aromas de manzanilla y lavanda.
Con cada respiración lenta y profunda, sientes cómo tus músculos se relajan y tu mente comienza a derivar.
La luz parpadeante del fuego proyecta sombras danzantes sobre las paredes de madera, creando un espectáculo hipnótico y fascinante.
Tus párpados se vuelven pesados,
tus pensamientos se ralentizan hasta arrastrarse mientras te envuelve la tranquilidad de este santuario montañoso.
El suave golpeteo de la lluvia comienza a caer afuera,
el delicado pitter-patter crea una banda sonora natural y rítmica para arrullarte hacia un sueño profundo y reparador.
Te hundes más en el sillón, tu cuerpo se vuelve más pesado y tu respiración se hace lenta y constante.
Las preocupaciones del día se desvanecen,
reemplazadas por un profundo sentido de calma y serenidad.
Estás a salvo
estás en paz
estás en casa
Mientras te deslizas hacia el sueño, una pequeña sonrisa cruza tus labios.
sabiendo que estás exactamente donde necesitas estar.`;

var spanishDictionary =`["acaba - finishes / ends","acogedora - welcoming","acurrucado - curled up","afuera - Outside","aire - air","árboles - trees","aromas - aromas / scents","aromático - aromatic","arrastrarse - to crawl / to drag oneself","arrullarte - to lull you (as in *arrullar* - to lull)","asciende - ascends / rises","bajo - under, low","banda - band / soundtrack (in context: *banda sonora* = soundtrack)","brisa - breeze","cabaña - cabin","cada - each, every","caer - to fall","cálido - warm","calienta - heats (3rd person singular of *calentar*)","caliente - hot","calma - serenity","calmante - soothing / calming","canadienses - Canadians","casa - house, home","chimenea - fireplace","comienza - begins","como - as, like, how","cómo - how","con - with","constante - constant","crea - create / believe (subjunctive or imperative)","creando - creating","crepitar - crackle","crujiente - crispy / crunchy","cruza - crosses","cuerpo - Body","cumbres - peaks / summits","danzantes - dancing","de - of, from","del - of the (de + el)","delicado - delicate","derivar - to drift / to derive","deslizas - slide","desvanecen - fade away","día - day","donde - where","dorado - golden","el - the","en - in, on","envuelve - envelops","es - is (from ser)","espectáculo - show / spectacle","estar - to be (temporary state)","estás - Are you?","este - this (masculine singular)","exactamente - exactly","fascinante - fascinating","fresca - cool","fuego - fire","golpeteo - tapping / knocking","hace - makes / does / ago","hacia - towards","hasta - until, up to, even","herbal - herbal","hipnótico - hypnotic","hojas - leaves","horizonte - horizon","hundes - you sink (informal command of *hundir* - to sink)","hundirse - to sink / to collapse","imponentes - imposing / majestic","la - the (feminine singular)","labios - lips","las - the (feminine plural)","lavanda - lavender","lenta - slow (feminine form)","llenando - filling","lluvia - rain","los - the (masculine plural)","luz - light","madera - wood","manos - hands","manzanilla - chamomile","más - more","mecen - rock / sway (3rd person plural of *mecer*)","mente - mind","mientras - while","montaña - mountain","montañoso - mountainous","mullido - fluffy / soft","músculos - muscles","nana - lullaby","natural - natural","necesitas - you need","nevadas - snow-covered / snowy (feminine plural)","pacífico - peaceful","para - for, in order to","paredes - walls","parpadeante - flickering","párpados - eyelids","paz - peace","pensamientos - thoughts","pequeña - small","pesado - heavy","pesados - heavy","pitter-patter - pitter-patter (onomatopoeia for light tapping)","por - by, for, through","preocupaciones - worries","profunda - deep","profundo - deep","proyecta - projects","proyectando - projecting","que - that, what","ralentizan - slow down","reemplazadas - replaced","relajan - relax (3rd person plural)","reparador - restorative / healing","respiración - breath","resplandor - glow / radiance","rítmica - rhythmic","rocosas - rocky","rodean - surround","rompe - breaks","sabiendo - knowing","salvo - safe / except / save","santuario - sanctuary","se - oneself, himself, herself, itself, themselves (reflexive pronoun), or used in impersonal constructions","sentido - sense / meaning","serenidad - serenity","sientes - you feel","silencio - silence","sillón - armchair / easy chair","sobre - on / over / about","sol - sun / alone","sombras - shadows","sonido - sound","sonora - sound / sonic (as in *banda sonora* - soundtrack)","sonrisa - smile","suave - soft","suavemente - gently / softly","sueño - dream / sleep","sus - his, her, its, their, your (formal) (plural)","susurrando - whispering","tarde - late / afternoon","taza - cup","té - tea","te - you (informal singular) (direct or indirect object pronoun)","tranquilidad - tranquility / calm","tranquilizadores - calming / soothing (plural adjective or noun: tranquilizers)","tu - your (informal singular)","tus - your (informal plural)","un - a, an (masculine)","una - a, an (feminine)","único - unique, only","vapor - steam / vapor","vuelve - return","vuelven - return","y - and"]`;
var slm =`{"a":{"start":0,"end":10},"á":{"start":5,"end":5},"b":{"start":11,"end":13},"c":{"start":14,"end":36},"d":{"start":37,"end":46},"e":{"start":47,"end":55},"f":{"start":56,"end":58},"g":{"start":59,"end":59},"h":{"start":60,"end":68},"i":{"start":69,"end":69},"l":{"start":70,"end":78},"m":{"start":79,"end":89},"n":{"start":90,"end":93},"p":{"start":94,"end":110},"q":{"start":111,"end":111},"r":{"start":112,"end":121},"s":{"start":122,"end":141},"t":{"start":142,"end":149},"u":{"start":150,"end":151},"ú":{"start":152,"end":152},"v":{"start":153,"end":155},"y":{"start":156,"end":156}}`;

//var EHIMGURL = './jiveRPG/canada/';
var EHIMGURL = 'https://ik.imagekit.io/pnscgil5d/ca/';
var reperc = {
    starter:false,
    storylines:[],
    starterParagraph:false,
    bmidx:false,
    storyvis:['ca_z.jpg','ca_y.jpg','ca_xy.jpg','ca_xx.jpg','ca_x.jpg','ca_w.jpg','ca_6.jpg','ca_u.jpg','ca_t.jpg','ca_s.jpg','ca_r.jpg','ca_q.jpg','ca_p.jpg','ca_o.jpg','ca_n.jpg','ca_m.jpg','ca_l.jpg','ca_k.jpg','ca_j.jpg','ca_i.jpg','ca_h.jpg','ca_g.jpg','ca_f.jpg','ca_e.jpg','ca_d.jpg','ca_c.jpg','ca_b.jpg','ca_a.jpg','ca_9.jpg','ca_8.jpg','ca_7.jpg','ca_5.jpg','ca_4.jpg','ca_3.jpg','ca_2.jpg','ca_1o.jpg','ca_1n.jpg','ca_1m.jpg','ca_1l.jpg','ca_1k.jpg','ca_1j.jpg','ca_1i.jpg','ca_1h.jpg','ca_1g.jpg','ca_1f.jpg','ca_1e.jpg','ca_1d.jpg','ca_1c.jpg','ca_1b.jpg','ca_1a.jpg','ca_1.jpg'],
    setBookmark:function(x){
        if(reperc.localstorage == false){return;}
        console.log('currentPar:'+x);
        reperc.bookmark[reperc.bmidx].cpar = x;
        reperc.localstorage.setItem('easternHeadBM',JSON.stringify(reperc.bookmark));
    },
    initBookmark:function(){
        const ehbmtitle = 'NDss3';
      
        if (typeof localStorage == "object"){
            reperc.localstorage =  localStorage;
        } else if (typeof globalStorage == "object"){
            reperc.localstorage = globalStorage[location.host];
        } else {
            reperc.localstorage = false;
        }
        if(reperc.localstorage !== false){
            reperc.bookmark = reperc.localstorage.getItem('easternHeadBM');
            if(reperc.bookmark == null){
                reperc.bookmark = [];
                reperc.bmidx = 0;
                reperc.bookmark[0] = {title:ehbmtitle,cpar:0};
            }
            else{
                reperc.bookmark = JSON.parse(reperc.bookmark);
                for(var i=0;i<reperc.bookmark.length;i++){
                    if(reperc.bookmark[i].title == ehbmtitle){
                        reperc.starterParagraph = reperc.bookmark[i].cpar;
                        reperc.bmidx = i;
                        break;
                    }
                }
                if(reperc.bmidx === false){
                    reperc.bmidx = reperc.bookmark.length;
                    reperc.bookmark[reperc.bmidx] = {title:ehbmtitle,cpar:0};
                }
            }
        }
    },
    initDictionary:function(){
        spanishDictionary = JSON.parse(spanishDictionary);
        reperc.letterMap = JSON.parse(slm);
    },
    initStory:function(){
        reperc.initBookmark();
        reperc.initDictionary();
        reperc.storyvidx = [];
        for(var i=0;i<reperc.storyvis.length;i++){
            reperc.storyvidx[reperc.storyvidx.length] = i;
        }
        textSt = textSt.split('<muoborder>');
        for(var i=0;i<textSt.length;i++){
            textSt[i] = textSt[i].trim();
            if(textSt[i] == '') continue;
            reperc.storylines[i] = [];
            textSt[i] = textSt[i].split('\n');
            for(var ix=0;ix<textSt[i].length;ix++){
                textSt[i][ix] = textSt[i][ix].trim();
                if(textSt[i][ix] == '') continue;
                reperc.storylines[i][reperc.storylines[i].length] = textSt[i][ix];
            }
        }
	},
    nextHdlr:function(x){
        var stvidx = jovuniverse.getrand(0,reperc.storyvidx.length);
        var stvi = reperc.storyvidx[stvidx];
        storyline.chapters[storyline.current_chap].elements.narration.illustration = EHIMGURL+reperc.storyvis[stvi];
        reperc.storyvidx.splice(stvidx,1);
        if(!reperc.storyvidx.length){
            for(var i=0;i<reperc.storyvis.length;i++){
                reperc.storyvidx[reperc.storyvidx.length] = i;
            }
        }
        reperc.setBookmark(x);
    },
    rp:function(){
        storyline.current_chap = reperc.starter;
        if(reperc.starterParagraph !== false){
          storyline.unfold_ = true;
          console.log('startingPar:'+reperc.starterParagraph);
          storyline.chapters[storyline.current_chap].unfoldx(reperc.starterParagraph);
        }
        else {
          storyline.chapters[storyline.current_chap].unfold();
        }
        var stvidx = jovuniverse.getrand(0,reperc.storyvidx.length);
        var stvi = reperc.storyvidx[stvidx];
        storyline.chapters[storyline.current_chap].elements.narration.illustration = EHIMGURL+reperc.storyvis[stvi];
        reperc.storyvidx.splice(stvidx,1);
        
        document.addEventListener('unfoldx', e => {
            reperc.nextHdlr(e.detail);          
        });        
  }
};

storyline.intro = `<p>One of a series of stories of the sleep-story genre in EasternHead's free Library designed to help you sleep, but also learn new words in foreign languages</p>
<div style="font-size:smaller;">
<p>Credits:</p>
<p>Stories:<br> AIs</p>
<p>Translation:<br> AIs</p>
<p>Images:<br><ul><li><a href="https://www.rawpixel.com" target="_blank">rawpixel.com</a></li><li><a href="https://www.pixabay.com" target="_blank">pixabay.com</a></li></ul></p></div>`;

storyline.lang = ['EN','ES'];
storyline.clang = storyline.deflang = 'es';
var chidx;
var n;

reperc.starter = 1;
config = {type:'repercussion',effect:new repercussion(reperc.rp),prerequisite:false};
chidx = storyline.addChapter(config);

reperc.initStory();
config = {type:'narration',narration:false};
n = new narration();
for(var i=0;i<reperc.storylines[1].length;i++){
    //es,en,fr,de,it,ru,ja,ko
	n.addNarration(reperc.storylines[1][i],reperc.storylines[0][i],null,null,null,null,null,null);
}
config.narration = n;
chidx = storyline.addChapter(config);

storyline.dictionfn = function(t,l){
    $('#dictionary').remove();
    $('.txtfrg.inq').removeClass('inq');
    const pos = $(l).offset();
    $(l).addClass('inq');
    t = t.toLowerCase().replace(/^[\p{P}\p{S}\s]+|[\p{P}\p{S}\s]+$/gu, '');
    t = t +' - ';
    let xx = t[0].toLowerCase();

    if(storyline.clang == 'es'){
        if (!reperc.letterMap[xx]){
            window.open('https://translate.google.com/?sl='+storyline.clang+'&tl=en&text='+t+'&op=translate');
            return;
        }
        for(var i=reperc.letterMap[xx].start;i<=reperc.letterMap[xx].end;i++){
            if(spanishDictionary[i].indexOf(t) === 0){
                $('body').append('<div id="dictionary" style="top:'+(pos.top-40)+'px;left:'+pos.left+'px;">'+spanishDictionary[i].split(' - ')[1]+'</div>').addClass('dictionInq');
                return;
            }
        }
        window.open('https://translate.google.com/?sl='+storyline.clang+'&tl=en&text='+t+'&op=translate');
    }
};

$('#text5').prop('src',EHIMGURL+'ca_v.jpg');

var textSt = `The Stillness of the Lakeside Cabin
The air is cool and soft tonight, carrying the gentle scent of pine needles and fresh water.
You are nestled deep within the Canadian wilderness
far from the hurried sounds of the city, in a small, wooden cabin beside a glassy lake.
You are safe here.
Listen closely.
The sounds of the day have faded.
All that remains is a peaceful, rhythmic pulse.
It's the sound of the lake itself, a soft, lapping whisper against the shore, saying, rest...
rest...
The Fire's Embrace Inside the cabin, the light is dim and warm.
The last of the wood in the small stone fireplace has settled into a bed of glowing embers.
You can see the faint, orange light flickering on the wooden ceiling beams above you.
Each tiny, silent movement of the fire is a soft, warm breath against the darkness.
Feel the deep, comfortable warmth spreading from the base of your spine,
melting away any tension you might have carried with you.
Breathe in slowly, deeply, letting your belly rise like a gentle wave on that smooth, dark lake.
And as you breathe out, let that warmth spread down into your legs and out through the soles of your feet.
You have nothing left to do now.
Nothing to hold onto.
the moon is high, a perfect silver coin hanging over the vast, quiet forest.
The tall spruce and cedar trees stand like silent guardians, their branches heavy with the night air.
The forest is asleep, and so are its creatures.
You might hear the distant, comforting call of a lonely loon
a sound that seems to cradle the entire night in its echo.
It is a peaceful, ancient sound that reminds you of how big and safe the world is, and how small and simple your worries are right now.
With every soft sound--the hush of the trees, the lap of the water, the gentle crackle of the embers--your eyelids are growing heavy.
So heavy.
Drifting Away Allow your mind to become as still as the lake outside.
Clear and deep and utterly undisturbed.
Imagine yourself drifting easily, floating weightlessly on that calm, dark water, held up by the night itself.
There is no effort in this.
You are simply held.
You are safe.
You are warm.
You are calm.
The darkness is soft and welcoming.
Let your breathing slow down even more, a long, deep sigh of surrender.
You are sinking deeper and deeper into the mattress, into the quiet of the cabin, into the deep, sweet rest you deserve.
Goodnight.
Sleep now.

<muoborder>

La Quietud de la Cabaña junto al Lago
El aire es fresco y suave esta noche, llevando el gentil aroma de agujas de pino y agua fresca.
Estás acurrucado profundamente en la naturaleza salvaje canadiense
lejos de los sonidos apresurados de la ciudad, en una pequeña cabaña de madera junto a un lago cristalino.
Estás a salvo aquí.
Escucha con atención.
Los sonidos del día se han desvanecido.
Todo lo que queda es un pulso pacífico y rítmico.
Es el sonido del lago mismo, un suave susurro de chapoteo contra la orilla, diciendo, descansa...
descansa...
El Abrazo del Fuego Dentro de la cabaña, la luz es tenue y cálida.
Lo último de la madera en la pequeña chimenea de piedra se ha acomodado en un lecho de brasas resplandecientes.
Puedes ver la tenue luz naranja parpadeando en las vigas de madera del techo sobre ti.
Cada pequeño y silencioso movimiento del fuego es un aliento suave y cálido contra la oscuridad.
Siente el profundo y cómodo calor extendiéndose desde la base de tu columna,
disolviendo cualquier tensión que pudieras haber traído contigo.
Inhala lentamente, profundamente, dejando que tu vientre se eleve como una ola suave en ese lago liso y oscuro.
Y al exhalar, deja que ese calor se extienda hacia abajo por tus piernas y salga por las plantas de tus pies.
No tienes nada más que hacer ahora.
Nada a lo que aferrarte.
la luna está alta, una moneda de plata perfecta colgando sobre el vasto y silencioso bosque.
Los altos abetos y cedros se yerguen como guardianes silenciosos, sus ramas pesadas con el aire nocturno.
El bosque está dormido, y también sus criaturas.
Podrías oír el lejano y reconfortante llamado de un colimbo solitario
un sonido que parece acunar toda la noche en su eco.
Es un sonido pacífico y antiguo que te recuerda cuán grande y seguro es el mundo, y cuán pequeños y simples son tus preocupaciones en este momento.
Con cada sonido suave --el susurro de los árboles, el chapoteo del agua, el suave crepitar de las brasas-- tus párpados se vuelven pesados.
Tan pesados.
A la Deriva Permite que tu mente se vuelva tan quieta como el lago afuera.
Clara y profunda y completamente inalterada.
Imagina que te deslizas fácilmente, flotando sin peso en esa agua calmada y oscura, sostenido por la noche misma.
No hay esfuerzo en esto.
Simplemente estás sostenido.
Estás a salvo.
Estás cálido.
Estás calmado.
La oscuridad es suave y acogedora.
Deja que tu respiración se ralentice aún más, un largo y profundo suspiro de rendición.
Te estás hundiendo más y más profundo en el colchón, en la quietud de la cabaña, en el profundo y dulce descanso que mereces.
Buenas noches.
Duerme ahora.`;

var spanishDictionary = `["abajo - below","abetos - firs","abrazo - embrace","acogedora - welcoming","acomodado - settled","acunar - cradle","acurrucado - curled up","aferrarte - to cling to","afuera - Outside","agua - water","agujas - needles","ahora - now","aire - air","al - to the (a + el)","aliento - breath","alta - high (feminine)","altos - High / Tall","antiguo - ancient","apresurados - hurried","aquí - here","árboles - trees","aroma - scent","atención - attention","aún - still, yet","base - base","bosque - forest, woods","brasas - embers","buenas - good (feminine plural)","cabaña - cabin","cada - each, every","cálida - warm","cálido - warm","calmada - calm","calmado - soothed","calor - warmth","canadiense - Canadian","cedros - cedars","chapoteo - splashing","chimenea - fireplace","ciudad - city","clara - clear","colchón - mattress","colgando - hanging","colimbo - loon","columna - column","como - as, like, how","cómodo - comfortable","completamente - completely","con - with","contigo - with you","contra - against","crepitar - crackle","criaturas - creatures","cristalino - crystalline","cualquier - any","cuán - how (intensifier)","de - of, from","deja - let","dejando - leaving","del - of the (de + el)","dentro - inside, within","deriva - drifts","descansa - rests","descanso - rest","desde - from, since","deslizas - slide","desvanecido - faded","día - day","diciendo - Saying","disolviendo - dissolving","dormido - sleeping","duerme - sleeps","dulce - sweet","eco - echo","el - the","eleve - lift","en - in, on","es - is (from ser)","esa - that (feminine singular)","escucha - listens","ese - that (masculine)","esfuerzo - effort","está - is (from estar)","esta - this (feminine singular)","estás - Are you?","este - this (masculine singular)","esto - this (neuter)","exhalar - exhale","extendiéndose - extending","extienda - extend","fácilmente - easily","flotando - floating","fresca - cool","fresco - fresh","fuego - fire","gentil - gentle","grande - big","guardianes - guardians","ha - has (from haber)","haber - to have (auxiliary) / there to be","hacer - to do, to make","hacia - towards","han - they have (from haber)","hay - there is, there are (from haber)","hundiendo - sinking","imagina - imagine","inalterada - unchanged","inhala - inhale","junto - together","la - the (feminine singular)","lago - lake","largo - long","las - the (feminine plural)","lecho - bed","lejano - distant","lejos - far / far away","lentamente - slowly","liso - smooth","llamado - called (past participle of llamar), call","llevando - carrying","lo - It / Him!","los - the (masculine plural)","luna - moon","luz - light","madera - wood","más - more","mente - mind","mereces - deserve","misma - same (feminine singular)","mismo - same, himself/herself/itself (after a pronoun)","momento - moment","moneda - coin","movimiento - movement","mundo - world","nada - nothing","naranja - orange","naturaleza - nature","noche - night","noches - nights","nocturno - Nocturnal / Nightly","oír - hear","ola - wave","orilla - shore","oscura - dark","oscuridad - darkness","oscuro - dark","pacífico - peaceful","parece - seems","parpadeando - flickering","párpados - eyelids","pequeña - small","pequeño - small","pequeños - small","perfecta - perfect","permite - allows","pesadas - heavy","pesados - heavy","peso - weight","piedra - stone","piernas - legs","pies - feet","pino - pine","plantas - plants","plata - silver","podrías - you could","por - by, for, through","preocupaciones - worries","profunda - deep","profundamente - deeply","profundo - deep","pudieras - could","puedes - you can (from poder)","pulso - pulse","que - that, what","queda - remains / is left","quieta - still","quietud - stillness","ralentice - slow down","ramas - branches","reconfortante - soothing","recuerda - remembers","rendición - surrender","respiración - breath","resplandecientes - glowing","rítmico - rhythmic","salga - leave / go out (subjunctive)","salvaje - wild","salvo - safe / except / save","se - oneself, himself, herself, itself, themselves (reflexive pronoun), or used in impersonal constructions","seguro - safe / sure / insurance","siente - feels","silencioso - silent","silenciosos - silent","simplemente - simply","simples - simple","sin - without","sobre - on / over / about","solitario - solitary","son - are","sonido - sound","sonidos - sounds","sostenido - sustained","su - his, her, its, their, your (formal)","suave - soft","sus - his, her, its, their, your (formal) (plural)","suspiro - sigh","susurro - whisper","también - also, too","tan - so / such / as","te - you (informal singular) (direct or indirect object pronoun)","techo - roof","tensión - tension","tenue - faint","ti - you (after a preposition)","tienes - you have (from tener)","toda - all, whole (feminine singular)","todo - all, whole, everything","traído - brought","tu - your (informal singular)","tus - your (informal plural)","último - final","un - a, an (masculine)","una - a, an (feminine)","vasto - vast","ver - to see","vientre - belly","vigas - beams","vuelva - return","vuelven - return","y - and","yerguen - stand"]`;
var slm =`{"a":{"start":0,"end":23},"á":{"start":20,"end":20},"b":{"start":24,"end":27},"c":{"start":28,"end":55},"d":{"start":56,"end":72},"e":{"start":73,"end":89},"f":{"start":90,"end":94},"g":{"start":95,"end":97},"h":{"start":98,"end":104},"i":{"start":105,"end":107},"j":{"start":108,"end":108},"l":{"start":109,"end":123},"m":{"start":124,"end":133},"n":{"start":134,"end":139},"o":{"start":140,"end":145},"p":{"start":146,"end":172},"q":{"start":173,"end":176},"r":{"start":177,"end":184},"s":{"start":185,"end":206},"t":{"start":207,"end":219},"ú":{"start":220,"end":220},"u":{"start":221,"end":222},"v":{"start":223,"end":228},"y":{"start":229,"end":230}}`;

//var EHIMGURL = './jiveRPG/canada/';
var EHIMGURL = 'https://ik.imagekit.io/pnscgil5d/ca';
var reperc = {
    starter:false,
    storylines:[],
    starterParagraph:false,
    bmidx:false,
    storyvis:['ca_6.jpg','ca_y.jpg','ca_xy.jpg','ca_xx.jpg','ca_x.jpg','ca_w.jpg','ca_v.jpg','ca_u.jpg','ca_t.jpg','ca_s.jpg','ca_r.jpg','ca_q.jpg','ca_p.jpg','ca_o.jpg','ca_n.jpg','ca_m.jpg','ca_l.jpg','ca_k.jpg','ca_j.jpg','ca_i.jpg','ca_h.jpg','ca_g.jpg','ca_f.jpg','ca_e.jpg','ca_d.jpg','ca_c.jpg','ca_b.jpg','ca_a.jpg','ca_9.jpg','ca_8.jpg','ca_7.jpg','ca_5.jpg','ca_4.jpg','ca_3.jpg','ca_2.jpg','ca_1o.jpg','ca_1n.jpg','ca_1m.jpg','ca_1l.jpg','ca_1k.jpg','ca_1j.jpg','ca_1i.jpg','ca_1h.jpg','ca_1g.jpg','ca_1f.jpg','ca_1e.jpg','ca_1d.jpg','ca_1c.jpg','ca_1b.jpg','ca_1a.jpg','ca_1.jpg'],
    setBookmark:function(x){
        if(reperc.localstorage == false){return;}
        console.log('currentPar:'+x);
        reperc.bookmark[reperc.bmidx].cpar = x;
        reperc.localstorage.setItem('easternHeadBM',JSON.stringify(reperc.bookmark));
    },
    initBookmark:function(){
        if (typeof localStorage == "object"){
            reperc.localstorage =  localStorage;
        } else if (typeof globalStorage == "object"){
            reperc.localstorage = globalStorage[location.host];
        } else {
            reperc.localstorage = false;
        }
        if(reperc.localstorage !== false){
            reperc.bookmark = reperc.localstorage.getItem('easternHeadBM');
            if(reperc.bookmark == null){
                reperc.bookmark = [];
                reperc.bmidx = 0;
                reperc.bookmark[0] = {title:'NDss2',cpar:0};
            }
            else{
                reperc.bookmark = JSON.parse(reperc.bookmark);
                for(var i=0;i<reperc.bookmark.length;i++){
                    if(reperc.bookmark[i].title == 'NDss2'){
                        reperc.starterParagraph = reperc.bookmark[i].cpar;
                        reperc.bmidx = i;
                        break;
                    }
                }
                if(reperc.bmidx === false){
                    reperc.bmidx = reperc.bookmark.length;
                    reperc.bookmark[reperc.bmidx] = {title:'NDss2',cpar:0};
                }
            }
        }
    },
    initDictionary:function(){
        spanishDictionary = JSON.parse(spanishDictionary);
        reperc.letterMap = JSON.parse(slm);
    },
    initStory:function(){
        reperc.initBookmark();
        reperc.initDictionary();
        reperc.storyvidx = [];
        for(var i=0;i<reperc.storyvis.length;i++){
            reperc.storyvidx[reperc.storyvidx.length] = i;
        }
        textSt = textSt.split('<muoborder>');
        for(var i=0;i<textSt.length;i++){
            textSt[i] = textSt[i].trim();
            if(textSt[i] == '') continue;
            reperc.storylines[i] = [];
            textSt[i] = textSt[i].split('\n');
            for(var ix=0;ix<textSt[i].length;ix++){
                textSt[i][ix] = textSt[i][ix].trim();
                if(textSt[i][ix] == '') continue;
                reperc.storylines[i][reperc.storylines[i].length] = textSt[i][ix];
            }
        }
	},
    nextHdlr:function(x){      
        var stvidx = jovuniverse.getrand(0,reperc.storyvidx.length);
        var stvi = reperc.storyvidx[stvidx];
        storyline.chapters[storyline.current_chap].elements.narration.illustration = EHIMGURL+reperc.storyvis[stvi];
        reperc.storyvidx.splice(stvidx,1);
        if(!reperc.storyvidx.length){
            for(var i=0;i<reperc.storyvis.length;i++){
                reperc.storyvidx[reperc.storyvidx.length] = i;
            }
        }
        reperc.setBookmark(x);
    },
    rp:function(){
        storyline.current_chap = reperc.starter;
        if(reperc.starterParagraph !== false){
          storyline.unfold_ = true;
          console.log('startingPar:'+reperc.starterParagraph);
          storyline.chapters[storyline.current_chap].unfoldx(reperc.starterParagraph);
        }
        else {
          storyline.chapters[storyline.current_chap].unfold();
        }
        var stvidx = jovuniverse.getrand(0,reperc.storyvidx.length);
        var stvi = reperc.storyvidx[stvidx];
        storyline.chapters[storyline.current_chap].elements.narration.illustration = EHIMGURL+reperc.storyvis[stvi];
        reperc.storyvidx.splice(stvidx,1);
        
        document.addEventListener('unfoldx', e => {
            reperc.nextHdlr(e.detail);          
        });
  }
};

storyline.intro = `<p>One of a series of stories of the sleep-story genre in EasternHead's free Library designed to help you sleep, but also learn new words in foreign languages</p>
<div style="font-size:smaller;">
<p>Credits:</p>
<p>Stories:<br> AIs</p>
<p>Translation:<br> AIs</p>
<p>Images:<br><ul><li><a href="https://www.rawpixel.com" target="_blank">rawpixel.com</a></li><li><a href="https://www.pixabay.com" target="_blank">pixabay.com</a></li></ul></p></div>`;

storyline.lang = ['EN','ES'];
storyline.clang = storyline.deflang = 'es';
var chidx;
var n;

reperc.starter = 1;
config = {type:'repercussion',effect:new repercussion(reperc.rp),prerequisite:false};
chidx = storyline.addChapter(config);

reperc.initStory();
config = {type:'narration',narration:false};
n = new narration();
for(var i=0;i<reperc.storylines[1].length;i++){
    //es,en,fr,de,it,ru,ja,ko
	n.addNarration(reperc.storylines[1][i],reperc.storylines[0][i],null,null,null,null,null,null);
}
config.narration = n;
chidx = storyline.addChapter(config);

storyline.dictionfn = function(t,l){
    $('#dictionary').remove();
    $('.txtfrg.inq').removeClass('inq');
    const pos = $(l).offset();
    $(l).addClass('inq');
    t = t.toLowerCase().replace(/^[\p{P}\p{S}\s]+|[\p{P}\p{S}\s]+$/gu, '');
    t = t +' - ';
    let xx = t[0].toLowerCase();

    if(storyline.clang == 'es'){
        if (!reperc.letterMap[xx]){
            window.open('https://translate.google.com/?sl='+storyline.clang+'&tl=en&text='+t+'&op=translate');
            return;
        }
        for(var i=reperc.letterMap[xx].start;i<=reperc.letterMap[xx].end;i++){
            if(spanishDictionary[i].indexOf(t) === 0){
                $('body').append('<div id="dictionary" style="top:'+(pos.top-40)+'px;left:'+pos.left+'px;">'+spanishDictionary[i].split(' - ')[1]+'</div>').addClass('dictionInq');
                return;
            }
        }
        window.open('https://translate.google.com/?sl='+storyline.clang+'&tl=en&text='+t+'&op=translate');
    }
};

$('#text5').prop('src',EHIMGURL+'ca_z.jpg');
